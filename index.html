<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="utf-8">
<title>Spausdinamos medžiagos būsena</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{
    font-family:system-ui,sans-serif;
    margin:0;
    padding:20px;
    text-align:center;
    background:#ffffff;
  }

  .logo{display:block;margin:0 auto 12px;max-height:80px;object-fit:contain;}
  .subtitle{font-size:.9rem;color:#6b7280;margin:-4px 0 4px;font-weight:400;}
  .public-note{font-size:.8rem;color:#b91c1c;margin:0 0 16px;}

  #list{max-width:600px;margin:0 auto;text-align:left;}
  .row{display:flex;gap:8px;margin-bottom:6px;align-items:center;}
  .row-delete{width:24px;text-align:center;cursor:pointer;font-weight:bold;color:#ef4444;user-select:none;}
  .row-number{width:32px;text-align:right;font-weight:bold;}
  .row input{flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:4px;}
  .row select{padding:6px 8px;border:1px solid #ccc;border-radius:4px;transition:background-color .3s;}

  .status-apdorojama{background:#fb923c;color:#000;}
  .status-gaminama {background:#fde047;color:#000;}
  .status-issiusta {background:#facc15;color:#000;}
  .status-gauta   {background:#4ade80;color:#fff;}

  #add-row{margin-top:12px;padding:8px 12px;border:none;background:#4F46E5;color:#fff;border-radius:4px;cursor:pointer;}
  #add-row:hover{background:#4338CA;}
</style>
</head>
<body>

<img class="logo" src="https://i.ibb.co/9HcFs71P/logoooo.png" alt="Circle K logo">
<h1>Spausdinamos medžiagos būsena</h1>
<p class="subtitle">Circle K Lietuva</p>
<p class="public-note">⚠︎ Ši lentelė redaguojama viešai – visi, turintys šią nuorodą, gali keisti ar trinti duomenis.</p>

<div id="list"></div>
<button id="add-row">Pridėti eilutę</button>

<!-- Firebase JS SDK (compat build) -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

<script>
// Firebase configuration – your project keys (public for web apps)
const firebaseConfig = {
  apiKey: "AIzaSyAClo8SsxFrOg88vOzgKmqUjYxXduNVH_U",
  authDomain: "ckprintai.firebaseapp.com",
  projectId: "ckprintai",
  storageBucket: "ckprintai.appspot.com",
  messagingSenderId: "34677922140",
  appId: "1:34677922140:web:bac80b67c3cbfe71ce0999",
  measurementId: "G-TZVE0S0ELS"
};

// Initialise Firebase (compat style)
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const rowsRef = db.collection('rows');

const list = document.getElementById('list');
const addRowBtn = document.getElementById('add-row');
const rowElems = new Map(); // docId -> DOM element

function updateColor(sel){
  sel.className = '';
  sel.classList.add('status-' + sel.value);
}

function createRowElement(doc){
  const data = doc.data();
  const id   = doc.id;
  const row  = document.createElement('div');
  row.className = 'row';
  row.dataset.id = id;

  // delete button
  const del = document.createElement('span');
  del.className = 'row-delete';
  del.textContent = '×';
  del.title = 'Ištrinti eilutę';
  del.addEventListener('click', () => {
    if (confirm('Ar tikrai norite ištrinti šią eilutę?')) {
      rowsRef.doc(id).delete();
    }
  });

  const num = document.createElement('span');
  num.className = 'row-number';

  const input = document.createElement('input');
  input.type = 'text';
  input.value = data.text || '';
  input.placeholder = 'Įveskite tekstą...';
  input.addEventListener('blur', () => {
    if (input.value !== data.text) {
      rowsRef.doc(id).update({ text: input.value });
    }
  });

  const select = document.createElement('select');
  select.innerHTML =
    '<option value="apdorojama">Apdorojama</option>'+
    '<option value="gaminama">Gaminama</option>'+
    '<option value="issiusta">Išsiųsta</option>'+
    '<option value="gauta">Gauta</option>';
  select.value = data.status || 'apdorojama';
  updateColor(select);
  select.addEventListener('change', () => {
    updateColor(select);
    rowsRef.doc(id).update({ status: select.value });
  });

  row.appendChild(del);
  row.appendChild(num);
  row.appendChild(input);
  row.appendChild(select);

  return row;
}

function renumberRows(){
  Array.from(list.children).forEach((rowEl, idx) => {
    const span = rowEl.querySelector('.row-number');
    if (span) span.textContent = idx + 1;
  });
}

// Real‑time listener with granular updates to keep input focus intact
rowsRef.orderBy('createdAt').onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    const doc = change.doc;
    const id  = doc.id;

    if (change.type === 'added') {
      if (rowElems.has(id)) return;
      const rowEl = createRowElement(doc);
      rowElems.set(id, rowEl);
      if (change.newIndex >= list.children.length) {
        list.appendChild(rowEl);
      } else {
        list.insertBefore(rowEl, list.children[change.newIndex]);
      }
      renumberRows();
    }

    if (change.type === 'modified') {
      const rowEl = rowElems.get(id);
      if (rowEl) {
        const input  = rowEl.querySelector('input');
        const select = rowEl.querySelector('select');
        if (document.activeElement !== input && input.value !== doc.data().text) {
          input.value = doc.data().text || '';
        }
        if (select.value !== doc.data().status) {
          select.value = doc.data().status || 'apdorojama';
          updateColor(select);
        }
      }
    }

    if (change.type === 'removed') {
      const rowEl = rowElems.get(id);
      if (rowEl) {
        rowEl.remove();
        rowElems.delete(id);
        renumberRows();
      }
    }
  });
});

// Add new row when button clicked
addRowBtn.addEventListener('click', () => {
  rowsRef.add({
    text: '',
    status: 'apdorojama',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
});
</script>
</body>
</html>
